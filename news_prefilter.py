# news_prefilter.py - Ð ÐÐ¡Ð¨Ð˜Ð Ð•ÐÐÐ«Ð™ Ð¡ÐŸÐ˜Ð¡ÐžÐš (LOOSE MODE)
import logging
import re
from typing import Dict

logger = logging.getLogger(__name__)

class NewsPreFilter:
    def __init__(self):
        # 1. Ð–ÐµÑÑ‚ÐºÐ¸Ðµ ÑÑ‚Ð¾Ð¿-ÑÐ»Ð¾Ð²Ð° (ÑÐ¿Ð°Ð¼, Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ)
        self.hard_reject_patterns = [
            r'Ð¿Ð¾Ð·Ð´Ñ€Ð°Ð²Ð»Ñ', r'Ñ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ¾Ð¼', r'Ð´Ð¾Ð±Ñ€Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾', r'Ð³Ð¾Ñ€Ð¾ÑÐºÐ¾Ð¿',
            r'Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', r'Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ', r'Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‚Ð¾Ñ€Ð³Ð°Ð¼',
            r'Ð²ÐµÐ±Ð¸Ð½Ð°Ñ€', r'ÑÐµÐ¼Ð¸Ð½Ð°Ñ€', r'ÐºÐ¾Ð½Ñ„ÐµÑ€ÐµÐ½Ñ†Ð¸', r'Ð¸Ñ‚Ð¾Ð³Ð¸ ÐºÐ¾Ð½ÐºÑƒÑ€ÑÐ°'
        ]
        
        # 2. Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ð¼Ð°Ñ€ÐºÐµÑ€Ñ‹ (Ð ÐÐ¡Ð¨Ð˜Ð Ð•ÐÐÐ«Ð™ Ð¡ÐŸÐ˜Ð¡ÐžÐš)
        # Ð•ÑÐ»Ð¸ Ð² Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸ ÐµÑÑ‚ÑŒ ÑÑ‚Ð¸ ÑÐ»Ð¾Ð²Ð°, Ð¼Ñ‹ Ð¾Ñ‚Ð´Ð°ÐµÐ¼ ÐµÑ‘ AI Ð½Ð° Ð°Ð½Ð°Ð»Ð¸Ð·
        self.financial_keywords = [
            # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ
            'Ð°ÐºÑ†Ð¸', 'Ð´Ð¸Ð²Ð¸Ð´ÐµÐ½Ð´', 'Ð¾Ñ‚Ñ‡ÐµÑ‚', 'Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ', 'ÑƒÐ±Ñ‹Ñ‚Ð¾Ðº', 'Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ°',
            'Ð¸Ð½Ð²ÐµÑÑ‚', 'Ñ‚Ñ€ÐµÐ¹Ð´', 'Ð±Ð¸Ñ€Ð¶Ð°', 'Ñ€Ñ‹Ð½Ð¾Ðº', 'ÐºÐ¾Ñ‚Ð¸Ñ€Ð¾Ð²Ðº', 'Ð¿Ð¾Ñ€Ñ‚Ñ„ÐµÐ»ÑŒ',
            'Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·', 'Ð°Ð½Ð°Ð»Ð¸Ð·', 'Ð¾Ð±Ð·Ð¾Ñ€', 'Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†', 'Ñ†ÐµÐ»ÐµÐ²Ð°Ñ Ñ†ÐµÐ½Ð°',
            # ÐœÐ°ÐºÑ€Ð¾
            'Ñ†Ð±', 'ÑÑ‚Ð°Ð²ÐºÐ°', 'Ð¸Ð½Ñ„Ð»ÑÑ†', 'Ð²Ð²Ð¿', 'ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ðº', 'ÑÐ°Ð½ÐºÑ†', 'ÑÐºÑÐ¿Ð¾Ñ€Ñ‚',
            'Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚', 'Ð½ÐµÑ„Ñ‚ÑŒ', 'Ð³Ð°Ð·', 'Ð·Ð¾Ð»Ð¾Ñ‚Ð¾', 'Ð²Ð°Ð»ÑŽÑ‚', 'Ñ€ÑƒÐ±Ð»ÑŒ', 'Ð´Ð¾Ð»Ð»Ð°Ñ€',
            # ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
            'ÑÐ¾Ð²ÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð²', 'ÑÐ´', 'ÑÐ´ÐµÐ»Ðº', 'ÑÐ»Ð¸ÑÐ½Ð¸', 'Ð¿Ð¾Ð³Ð»Ð¾Ñ‰ÐµÐ½', 'ipo',
            'spo', 'Ð±Ð°Ð¹Ð±ÐµÐº', 'Ð²Ñ‹ÐºÑƒÐ¿', 'Ð´Ð¾Ð¿ÑÐ¼Ð¸ÑÑÐ¸', 'ÐºÐ¾Ð½Ñ‚Ñ€Ð°ÐºÑ‚', 'Ð·Ð°Ð¿ÑƒÑÐº',
            # Ð¢Ð¸ÐºÐµÑ€Ñ‹ Ð¸ ÑÐ»ÐµÐ½Ð³
            'ÑÐ±ÐµÑ€', 'Ð³Ð°Ð·Ð¿Ñ€Ð¾Ð¼', 'Ð»ÑƒÐºÐ¾Ð¹Ð»', 'ÑÐ½Ð´ÐµÐºÑ', 'Ð¼Ð°Ð³Ð½Ð¸Ñ‚', 'Ð²Ñ‚Ð±', 'Ñ‚Ð¸Ð½ÑŒÐºÐ¾Ñ„Ñ„',
            'Ð½Ð¾Ñ€Ð½Ð¸ÐºÐµÐ»ÑŒ', 'ÑÐµÐ²ÐµÑ€ÑÑ‚Ð°Ð»ÑŒ', 'Ñ€Ð¾ÑÑ‚ÐµÐ»ÐµÐºÐ¾Ð¼', 'ÑÐ¸ÑÑ‚ÐµÐ¼Ð°', 'Ð°Ñ„Ðº', 'ozon',
            'moex', 'sber', 'gazp', 'lkoh', 'yndx', 'vtbr', 'tcs', 'gmkn'
        ]
        
        logger.info("ðŸ”§ NewsPreFilter: ÐžÑÐ»Ð°Ð±Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (Ð›Ð¾Ð²Ð¸Ð¼ Ð²ÑÑ‘ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ðµ)")

    def is_tradable(self, news_item: Dict) -> bool:
        title = news_item.get('title', '').lower()
        content = news_item.get('content', '').lower() or news_item.get('description', '').lower()
        full_text = f"{title} {content[:500]}" # Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°

        # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÑÑ‚Ð¾Ð¿-ÑÐ»Ð¾Ð²Ð°
        for pattern in self.hard_reject_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                # logger.info(f"ðŸ—‘ï¸ Filter Reject: Ð¡Ð¿Ð°Ð¼/Tech -> {title[:30]}...") 
                # (ÐœÐ¾Ð¶Ð½Ð¾ Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ÑÐ¿Ð°Ð¼)
                return False

        # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ð¼Ð°Ñ€ÐºÐµÑ€Ñ‹
        # Ð’ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð¼Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÑ‘, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ…Ð¾Ð¶Ðµ Ð½Ð° Ñ€Ñ‹Ð½Ð¾Ðº
        has_financial = any(keyword in full_text for keyword in self.financial_keywords)
        
        if has_financial:
            return True

        # Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¼Ð°Ñ€ÐºÐµÑ€Ð¾Ð², Ð½Ð¾ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¹ Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ†Ð¸Ñ„Ñ€Ñ‹ (Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹), Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ
        if len(full_text) > 50 and '%' in full_text:
            return True

        return False

# news_prefilter.py
import logging
import re
from typing import Dict, List

logger = logging.getLogger(__name__)

class NewsPreFilter:
    """ÐŸÑ€Ðµ-Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð´Ð»Ñ Ð¾Ñ‚ÑÐµÐ²Ð° Ð¼ÑƒÑÐ¾Ñ€Ð½Ñ‹Ñ… Ð¸ Ð½ÐµÑ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ñ… Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹"""
    
    def __init__(self):
        # ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ ÐžÐ¢Ð¡Ð•Ð’Ð (Ð¼ÑƒÑÐ¾Ñ€Ð½Ñ‹Ðµ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸)
        self.reject_keywords = [
            # Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ/Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ
            'ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ Ð½Ð¾Ñ‚Ñ‹', 'Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹', 'Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ',
            'Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ', 'ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ', 'Ð¸Ð·Ð²ÐµÑ‰ÐµÐ½Ð¸Ðµ',
            'Ð¾Ð±Ð»Ð¸Ð³Ð°Ñ†Ð¸ÑÐ¼Ð¸', 'Ð¾Ð±Ð»Ð¸Ð³Ð°Ñ†Ð¸Ð¸', 'ÐºÑƒÐ¿Ð¾Ð½', 'Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½', 
            'Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÑ€Ñ‹Ð²', 'Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹',
            
            # ÐÐµÑ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ
            'Ð¸Ñ‚Ð¾Ð³Ð¸ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²', 'ÑÐ²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚', 'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ',
            'Ð¾Ð± Ð¸Ñ‚Ð¾Ð³Ð°Ñ…', 'Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ð¸', 'Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸',
            'Ð¿Ñ€ÐµÑÑ-Ñ€ÐµÐ»Ð¸Ð·', 'Ð¿Ñ€ÐµÑÑ Ñ€ÐµÐ»Ð¸Ð·', 'Ð°Ð½Ð¾Ð½Ñ', 'Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸',
            
            # ÐÐµÑ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ
            'Ð±Ð»Ð°Ð³Ð¾Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½', 'ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½', 'ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½', 'Ñ€Ð°Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÐµÐ»ÑŒÐ½',
            'Ñ…Ð¾Ð±Ð±Ð¸', 'ÑƒÐ²Ð»ÐµÑ‡ÐµÐ½', 'Ð¾Ñ‚Ð´Ñ‹Ñ…', 'Ñ‚ÑƒÑ€Ð¸Ð·Ð¼', 'Ð¿ÑƒÑ‚ÐµÑˆÐµÑÑ‚Ð²'
        ]
        
        # ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ ÐŸÐ Ð˜ÐÐ¯Ð¢Ð˜Ð¯ (Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹)
        self.accept_keywords = [
            # Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹
            'Ð´Ð¸Ð²Ð¸Ð´ÐµÐ½Ð´', 'Ð¾Ñ‚Ñ‡ÐµÑ‚Ð½Ð¾ÑÑ‚ÑŒ', 'Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ', 'Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ°', 'ÑƒÐ±Ñ‹Ñ‚Ð¾Ðº',
            'ÐºÐ²Ð°Ñ€Ñ‚Ð°Ð»', 'Ð³Ð¾Ð´Ð¾Ð²Ð¾Ð¹', 'Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹',
            'ebitda', 'Ñ‡Ð¸ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ', 'Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ',
            
            # ÐšÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
            'ÑÐ»Ð¸ÑÐ½Ð¸', 'Ð¿Ð¾Ð³Ð»Ð¾Ñ‰ÐµÐ½', 'Ð²Ñ‹ÐºÑƒÐ¿', 'Ð´Ñ€Ð¾Ð±Ð»ÐµÐ½', 'ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸Ð´Ð°Ñ†',
            'Ñ€ÐµÐ¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†', 'Ñ€ÐµÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ð·Ð°Ñ†', 'Ð±Ð°Ð½ÐºÑ€Ð¾Ñ‚ÑÑ‚Ð²',
            
            # Ð ÐµÐ³ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð½Ñ‹Ðµ
            'ÑÐ°Ð½ÐºÑ†', 'Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½', 'Ð·Ð°Ð¿Ñ€ÐµÑ‚', 'Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½',
            'Ñ†Ð±', 'Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð°Ð½Ðº', 'Ð¼Ð¸Ð½Ñ„Ð¸Ð½', 'Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²',
            'Ñ€ÐµÐ³ÑƒÐ»ÑÑ‚Ð¾Ñ€', 'Ð½Ð°Ð´Ð·Ð¾Ñ€', 'Ð¸Ð½ÑÐ¿ÐµÐºÑ†',
            
            # ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð·Ñ‹ Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸
            'Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ñƒ', 'ÑÐ¾Ð²ÐµÑ‚ÑƒÐµÑ‚', 'Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚', 'Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚',
            'Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·', 'Ñ†ÐµÐ»ÐµÐ²Ð°Ñ Ñ†ÐµÐ½Ð°', 'Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº', 'ÑÐºÑÐ¿ÐµÑ€Ñ‚',
            'Ð¿Ð¾Ð²Ñ‹ÑˆÐ°ÐµÑ‚', 'ÑÐ½Ð¸Ð¶Ð°ÐµÑ‚', 'Ð¿ÐµÑ€ÐµÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°ÐµÑ‚'
        ]
        
        # ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¼ÑƒÑÐ¾Ñ€Ð½Ñ‹Ñ… Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹
        self.reject_patterns = [
            r'Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²',
            r'ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ Ð½Ð¾Ñ‚Ñ‹.*Ð±ÐºÑ',
            r'Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.*Ð¼Ð¾ÑÐºÐ¾Ð²ÑÐºÐ¾Ð¹ Ð±Ð¸Ñ€Ð¶',
            r'Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²',
            r'Ð¸Ñ‚Ð¾Ð³Ð¸ Ñ‚Ð¾Ñ€Ð³Ð¾Ð².*Ð¾Ð±Ð»Ð¸Ð³Ð°Ñ†Ð¸ÑÐ¼Ð¸',
            r'Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.*Ð¼Ð¾ÑÐºÐ¾Ð²ÑÐºÐ¾Ð¹ Ð±Ð¸Ñ€Ð¶'
        ]
        
        logger.info(f"ðŸ”§ NewsPreFilter Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
        logger.info(f"   ÐžÑ‚ÑÐµÐ²: {len(self.reject_keywords)} ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²")
        logger.info(f"   ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¸Ðµ: {len(self.accept_keywords)} ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²")
    
    def is_tradable(self, news_item: Dict) -> bool:
        """ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð½Ð¾Ð²Ð¾ÑÑ‚ÑŒ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ð¼ ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð¼"""
        title = news_item.get('title', '').lower()
        content = news_item.get('content', '').lower() or news_item.get('description', '').lower()
        full_text = f"{title} {content[:300]}"  # ÐŸÐµÑ€Ð²Ñ‹Ðµ 300 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
        
        # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÑÐ²Ð½Ñ‹Ð¹ Ð¼ÑƒÑÐ¾Ñ€ Ð¿Ð¾ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð°Ð¼
        for pattern in self.reject_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                logger.debug(f"âŒ ÐžÑ‚ÑÐµÑÐ½ Ð¿Ð¾ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñƒ: {pattern[:50]}")
                return False
        
        # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾Ñ‚ÑÐµÐ² Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ð¼
        reject_count = sum(1 for keyword in self.reject_keywords if keyword in full_text)
        if reject_count >= 2:  # Ð•ÑÐ»Ð¸ 2+ Ð¾Ñ‚ÑÐµÐ²Ð½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²Ð°
            logger.debug(f"âŒ ÐžÑ‚ÑÐµÑÐ½: {reject_count} Ð¾Ñ‚ÑÐµÐ²Ð½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²")
            return False
        
        # 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹
        accept_count = sum(1 for keyword in self.accept_keywords if keyword in full_text)
        
        # 4. Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð´Ð»Ñ MOEX Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹
        if 'moex' in news_item.get('source', '').lower():
            # MOEX Ñ‡Ð°ÑÑ‚Ð¾ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸
            if any(word in title for word in ['Ð¾Ð±Ð»Ð¸Ð³Ð°Ñ†Ð¸ÑÐ¼Ð¸', 'ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ', 'Ð¸Ñ‚Ð¾Ð³Ð¸', 'ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ']):
                return False
        
        # 5. Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
        if accept_count >= 1:
            logger.debug(f"âœ… ÐŸÑ€Ð¸Ð½ÑÑ‚: {accept_count} Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²")
            return True
        
        logger.debug(f"âŒ ÐžÑ‚ÑÐµÑÐ½: Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²")
        return False
    
    def get_filter_stats(self, news_list: List[Dict]) -> Dict:
        """Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸"""
        total = len(news_list)
        tradable = sum(1 for news in news_list if self.is_tradable(news))
        
        return {
            'total_news': total,
            'tradable_news': tradable,
            'rejected_news': total - tradable,
            'tradable_percent': round((tradable / total * 100) if total > 0 else 0, 1),
            'filter_version': '1.0'
        }

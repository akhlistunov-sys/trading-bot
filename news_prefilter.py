# news_prefilter.py - Ğ£Ğ–Ğ•Ğ¡Ğ¢ĞĞ§Ğ•ĞĞĞ«Ğ™ ĞŸĞ Ğ•Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ 
import logging
import re
from typing import Dict, List

logger = logging.getLogger(__name__)

class NewsPreFilter:
    """Ğ£Ğ¶ĞµÑÑ‚Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğµ-Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹"""
    
    def __init__(self):
        # Ğ–Ğ•Ğ¡Ğ¢ĞšĞ˜Ğ• ĞĞ¢Ğ¡Ğ•Ğ’Ğ« (Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ/Ğ½ĞµÑ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğµ)
        self.reject_keywords = [
            # Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
            'ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ½Ğ¾Ñ‚Ñ‹', 'Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', 'Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹',
            'Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑ€Ñ‹Ğ²', 'Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ', 'Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ',
            'ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸', 'Ğ¾Ğ± Ğ¸Ñ‚Ğ¾Ğ³Ğ°Ñ… Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²', 'Ğ¸Ñ‚Ğ¾Ğ³Ğ¸ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²',
            'Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²', 'Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²', 'Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ°ĞºÑ‚Ğ¸ĞºĞ°',
            
            # ĞĞ±Ğ»Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸/Ğ´Ğ¾Ğ»Ğ³Ğ¸
            'Ğ¾Ğ±Ğ»Ğ¸Ğ³Ğ°Ñ†Ğ¸', 'ĞºÑƒĞ¿Ğ¾Ğ½', 'Ğ¿Ğ¾Ğ³Ğ°ÑˆĞµĞ½', 'Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚', 'Ğ±Ğ°Ğ½ĞºÑ€Ğ¾Ñ‚ÑÑ‚Ğ²', 'Ğ´Ğ¾Ğ»Ğ³',
            'Ğ·Ğ°ĞµĞ¼', 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚', 'Ğ²Ñ‹Ğ¿ÑƒÑĞº Ğ¾Ğ±Ğ»Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¹',
            
            # ĞĞµÑ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğµ
            'Ğ¿Ñ€ĞµÑÑ-Ñ€ĞµĞ»Ğ¸Ğ·', 'Ğ¿Ñ€ĞµÑÑ Ñ€ĞµĞ»Ğ¸Ğ·', 'Ğ°Ğ½Ğ¾Ğ½Ñ Ğ¼ĞµÑ€Ğ¾Ğ¿Ñ€Ğ¸ÑÑ‚Ğ¸Ñ',
            'Ğ±Ğ»Ğ°Ğ³Ğ¾Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½', 'ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ğ²Ğ½', 'ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ½', 'ÑĞ¾Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½',
            'Ğ¼ĞµÑ€Ğ¾Ğ¿Ñ€Ğ¸ÑÑ‚Ğ¸Ğµ', 'ĞºĞ¾Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ†', 'Ñ„Ğ¾Ñ€ÑƒĞ¼', 'Ğ²Ñ‹ÑÑ‚Ğ°Ğ²Ğº'
        ]
        
        # ĞŸĞ Ğ˜ĞĞ¯Ğ¢Ğ˜Ğ• (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹)
        self.accept_keywords = [
            # ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
            'ÑĞ±ĞµÑ€Ğ±Ğ°Ğ½Ğº', 'Ğ³Ğ°Ğ·Ğ¿Ñ€Ğ¾Ğ¼', 'Ğ»ÑƒĞºĞ¾Ğ¹Ğ»', 'Ğ½Ğ¾Ñ€Ğ¸Ğ»ÑŒÑĞº', 'ÑĞ½Ğ´ĞµĞºÑ', 'Ğ¾Ğ·Ğ¾Ğ½',
            'Ğ½Ğ¾Ñ€Ğ½Ğ¸ĞºĞµĞ»ÑŒ', 'Ñ‚Ğ¸Ğ½ÑŒĞºĞ¾Ñ„Ñ„', 'Ğ²Ñ‚Ğ±', 'Ğ¼Ğ°Ğ³Ğ½Ğ¸Ñ‚', 'Ñ‚Ğ°Ñ‚Ğ½ĞµÑ„Ñ‚ÑŒ', 'Ğ°ÑÑ€Ğ¾Ñ„Ğ»Ğ¾Ñ‚',
            'Ñ€ÑƒÑĞ³Ğ¸Ğ´Ñ€Ğ¾', 'Ğ¸Ğ½Ñ‚ĞµÑ€ Ñ€Ğ°Ğ¾', 'Ğ°Ñ„Ğº ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°', 'Ñ€Ğ¾ÑÑ‚ĞµĞ»ĞµĞºĞ¾Ğ¼',
            
            # Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
            'Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´', 'Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ', 'ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»', 'Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹',
            'Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ', 'Ğ²Ñ‹Ñ€ÑƒÑ‡ĞºĞ°', 'ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº', 'ebitda', 'Ñ‡Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ',
            
            # Ğ Ñ‹Ğ½Ğ¾Ğº
            'ĞºĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğº', 'Ğ±Ğ¸Ñ€Ğ¶', 'Ñ€Ñ‹Ğ½Ğ¾Ğº', 'Ğ¸Ğ½Ğ²ĞµÑÑ‚', 'Ñ‚Ñ€ĞµĞ¹Ğ´', 'Ğ°ĞºÑ†Ğ¸',
            'Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº', 'Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·', 'Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½', 'Ñ†ĞµĞ»ĞµĞ²Ğ°Ñ Ñ†ĞµĞ½Ğ°',
            'Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ĞµÑ‚', 'ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚', 'Ğ¿ĞµÑ€ĞµÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°ĞµÑ‚',
            
            # Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°
            'ÑĞ°Ğ½ĞºÑ†', 'Ñ†Ğ±', 'Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ½Ğº', 'Ğ¼Ğ¸Ğ½Ñ„Ğ¸Ğ½', 'Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²',
            'Ñ€ĞµĞ³ÑƒĞ»ÑÑ‚Ğ¾Ñ€', 'Ğ½Ğ°Ğ´Ğ·Ğ¾Ñ€', 'ÑˆÑ‚Ñ€Ğ°Ñ„',
            
            # Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹
            'Ğ½ĞµÑ„Ñ‚', 'Ğ³Ğ°Ğ·', 'Ğ·Ğ¾Ğ»Ğ¾Ñ‚', 'Ñ€ÑƒĞ±Ğ»', 'Ğ´Ğ¾Ğ»Ğ»Ğ°Ñ€', 'ĞµĞ²Ñ€Ğ¾',
        ]
        
        # ĞĞ‘Ğ¡ĞĞ›Ğ®Ğ¢ĞĞ«Ğ™ Ğ¾Ñ‚ÑĞµĞ²
        self.hard_reject_patterns = [
            r'ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ½Ğ¾Ñ‚Ñ‹',
            r'Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹',
            r'Ğ¸Ñ‚Ğ¾Ğ³Ğ¸ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ².*Ğ¾Ğ±Ğ»Ğ¸Ğ³Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸',
            r'ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ.*Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸',
            r'Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ',
            r'Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²'
        ]
        
        logger.info(f"ğŸ”§ NewsPreFilter Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (Ğ£Ğ–Ğ•Ğ¡Ğ¢ĞĞ§Ğ•ĞĞĞ«Ğ™)")
        logger.info(f"   ĞÑ‚ÑĞµĞ²: {len(self.reject_keywords)} ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞ»Ğ¾Ğ²")
        logger.info(f"   ĞŸÑ€Ğ¸Ğ½ÑÑ‚Ğ¸Ğµ: {len(self.accept_keywords)} ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞ»Ğ¾Ğ²")
    
    def is_tradable(self, news_item: Dict) -> bool:
        """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ¼"""
        title = news_item.get('title', '').lower()
        content = news_item.get('content', '').lower() or news_item.get('description', '').lower()
        full_text = f"{title} {content[:500]}"
        
        # 1. ĞĞ‘Ğ¡ĞĞ›Ğ®Ğ¢ĞĞ«Ğ™ Ğ¾Ñ‚ÑĞµĞ²
        for pattern in self.hard_reject_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                logger.debug(f"âŒ Hard reject: {pattern[:40]}")
                return False
        
        # 2. ĞŸĞ¾Ğ´ÑÑ‡ĞµÑ‚ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞ»Ğ¾Ğ²
        accept_count = sum(1 for kw in self.accept_keywords if kw in full_text)
        reject_count = sum(1 for kw in self.reject_keywords if kw in full_text)
        
        # 3. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ
        if reject_count >= 3 and accept_count <= 1:
            logger.debug(f"âŒ Reject: reject={reject_count}, accept={accept_count}")
            return False
        
        if accept_count >= 1:
            logger.debug(f"âœ… Accept: accept={accept_count}")
            return True
        
        # MOEX Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ - Ğ±Ğ¾Ğ»ĞµĞµ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾
        if 'moex' in news_item.get('source', '').lower():
            if any(word in title for word in ['Ğ¾Ğ±Ğ»Ğ¸Ğ³Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸', 'ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ', 'Ğ¸Ñ‚Ğ¾Ğ³Ğ¸']):
                return False
            if accept_count >= 3:
                return True
        
        logger.debug(f"âŒ Default reject: accept={accept_count}")
        return False

# news_prefilter.py - –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–ï–§–ò–õ–¨–¢–†
import logging
import re
from typing import Dict, List

logger = logging.getLogger(__name__)

class NewsPreFilter:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–µ-—Ñ–∏–ª—å—Ç—Ä –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π"""
    
    def __init__(self):
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –û–¢–°–ï–í–ê (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ/–Ω–µ—Ç–æ—Ä–≥–æ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏)
        self.reject_keywords = [
            # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –æ—Ç—Å–µ–≤ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã)
            '—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –Ω–æ—Ç—ã', '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã', '–ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã',
            '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤', '–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è', '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è',
            '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏', '–æ–± –∏—Ç–æ–≥–∞—Ö —Ç–æ—Ä–≥–æ–≤', '–∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤',
            
            # –ú—è–≥–∫–∏–π –æ—Ç—Å–µ–≤ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç)
            '–æ–±–ª–∏–≥–∞—Ü–∏', '–∫—É–ø–æ–Ω', '–ø–æ–≥–∞—à–µ–Ω', '–¥–µ—Ñ–æ–ª—Ç', '–±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤',
            
            # –ù–µ—Ç–æ—Ä–≥–æ–≤—ã–µ
            '–ø—Ä–µ—Å—Å-—Ä–µ–ª–∏–∑', '–ø—Ä–µ—Å—Å —Ä–µ–ª–∏–∑', '–∞–Ω–æ–Ω—Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è',
            '–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω', '—Å–ø–æ—Ä—Ç–∏–≤–Ω', '–∫—É–ª—å—Ç—É—Ä–Ω'
        ]
        
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ü–†–ò–ù–Ø–¢–ò–Ø (—Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã) - –†–ê–°–®–ò–†–ï–ù–ù–´–ô
        self.accept_keywords = [
            # –ö–æ–º–ø–∞–Ω–∏–∏ –∏ —Ç–∏–∫–µ—Ä—ã
            '—Å–±–µ—Ä–±–∞–Ω–∫', '–≥–∞–∑–ø—Ä–æ–º', '–ª—É–∫–æ–π–ª', '—Ä–æ—Å—Ç–µ–ª–µ–∫–æ–º', '—è–Ω–¥–µ–∫—Å', '–æ–∑–æ–Ω',
            '–Ω–æ—Ä–Ω–∏–∫–µ–ª—å', '—Ç–∏–Ω—å–∫–æ—Ñ—Ñ', '–≤—Ç–±', '–º–∞–≥–Ω–∏—Ç', '–Ω–æ—Ä–∏–ª—å—Å–∫', '—Ç–∞—Ç–Ω–µ—Ñ—Ç—å',
            '–∞—ç—Ä–æ—Ñ–ª–æ—Ç', '—Ä—É—Å–≥–∏–¥—Ä–æ', '–∏–Ω—Ç–µ—Ä —Ä–∞–æ', '–∞—Ñ–∫ —Å–∏—Å—Ç–µ–º–∞',
            
            # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
            '–¥–∏–≤–∏–¥–µ–Ω–¥', '–¥–∏–≤–∏–¥–µ–Ω–¥—ã', '–¥–∏–≤–∏–¥–µ–Ω–¥–Ω', '–≤—ã–ø–ª–∞—Ç–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤',
            '–æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å', '–∫–≤–∞—Ä—Ç–∞–ª', '—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', '–ø—Ä–∏–±—ã–ª—å',
            '–≤—ã—Ä—É—á–∫–∞', '—É–±—ã—Ç–æ–∫', 'ebitda', '—á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å',
            
            # –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            '—Å–ª–∏—è–Ω–∏', '–ø–æ–≥–ª–æ—â–µ–Ω', '–≤—ã–∫—É–ø', '—Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü', '—Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü',
            '—Å–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤', '–∞–∫—Ü–∏–æ–Ω–µ—Ä', '—ç–º–∏—Å—Å–∏',
            
            # –†—ã–Ω–æ–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
            '–∫–æ—Ç–∏—Ä–æ–≤–∫', '–±–∏—Ä–∂', '—Ä—ã–Ω–æ–∫', '–∏–Ω–≤–µ—Å—Ç', '—Ç—Ä–µ–π–¥', '–∞–∫—Ü–∏',
            '—Ä–µ–∫–æ–º–µ–Ω–¥—É', '–∞–Ω–∞–ª–∏—Ç–∏–∫', '–ø—Ä–æ–≥–Ω–æ–∑', '–æ–∂–∏–¥–∞–Ω', '—Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞',
            '–ø–æ–≤—ã—à–∞–µ—Ç', '—Å–Ω–∏–∂–∞–µ—Ç', '–ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç',
            
            # –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã
            '—Å–∞–Ω–∫—Ü', '—Ü–±', '—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫', '–º–∏–Ω—Ñ–∏–Ω', '–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤',
            '—Ä–µ–≥—É–ª—è—Ç–æ—Ä', '–Ω–∞–¥–∑–æ—Ä', '—à—Ç—Ä–∞—Ñ', '–Ω–∞–∫–∞–∑–∞–Ω–∏–µ',
            
            # –¢–æ–≤–∞—Ä—ã –∏ –≤–∞–ª—é—Ç—ã
            '–Ω–µ—Ñ—Ç', '–≥–∞–∑', '–∑–æ–ª–æ—Ç', '—Ä—É–±–ª', '–¥–æ–ª–ª–∞—Ä', '–µ–≤—Ä–æ',
            
            # –û–±—â–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
            '–∫–æ–º–ø–∞–Ω–∏', '—Ñ–æ–Ω–¥', '—Ä—ã–Ω–æ—á–Ω', '—ç–∫–æ–Ω–æ–º–∏–∫', '–ø–æ–∫—É–ø–∫', '–ø—Ä–æ–¥–∞–∂',
            '—Å–¥–µ–ª–∫–∞', '–∏–Ω–≤–µ—Å—Ç–∏—Ü', '–ø–æ—Ä—Ç—Ñ–µ–ª'
        ]
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ì–û –æ—Ç—Å–µ–≤–∞
        self.hard_reject_patterns = [
            r'—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –Ω–æ—Ç—ã.*–±–∫—Å',
            r'—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã.*–º–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂',
            r'–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ—Ä–≥–æ–≤',
            r'–∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤.*–æ–±–ª–∏–≥–∞—Ü–∏—è–º–∏',
            r'–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤',
            r'—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.*–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏'
        ]
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –°–ò–õ–¨–ù–´–• —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (–ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å reject)
        self.strong_signal_patterns = [
            r'–¥–∏–≤–∏–¥–µ–Ω–¥.*—É–≤–µ–ª–∏—á', r'–¥–∏–≤–∏–¥–µ–Ω–¥.*—Ä–æ—Å—Ç', r'–¥–∏–≤–∏–¥–µ–Ω–¥.*–≤—ã–ø–ª–∞—Ç',
            r'–ø—Ä–∏–±—ã–ª—å.*–≤—ã—Ä–æ—Å', r'–≤—ã—Ä—É—á–∫–∞.*—É–≤–µ–ª–∏—á', r'–æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å.*–ª—É—á—à–µ',
            r'—Å–ª–∏—è–Ω–∏.*–∫–æ–º–ø–∞–Ω–∏', r'–ø–æ–≥–ª–æ—â–µ–Ω.*–∞–∫—Ç–∏–≤',
            r'—Å–∞–Ω–∫—Ü.*–ø—Ä–æ—Ç–∏–≤', r'—Ü–±.*—Ä–µ—à–µ–Ω'
        ]
        
        logger.info(f"üîß NewsPreFilter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)")
        logger.info(f"   –ü—Ä–∏–Ω—è—Ç–∏–µ: {len(self.accept_keywords)} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤")
        logger.info(f"   –û—Ç—Å–µ–≤: {len(self.reject_keywords)} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤")
        logger.info(f"   –°–∏–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã: {len(self.strong_signal_patterns)} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤")
    
    def is_tradable(self, news_item: Dict) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–≤–æ—Å—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–º —Å–∏–≥–Ω–∞–ª–æ–º (—É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)"""
        title = news_item.get('title', '').lower()
        content = news_item.get('content', '').lower() or news_item.get('description', '').lower()
        full_text = f"{title} {content[:500]}"  # –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ê–ë–°–û–õ–Æ–¢–ù–´–ô –æ—Ç—Å–µ–≤ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
        for pattern in self.hard_reject_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                logger.debug(f"‚ùå –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –æ—Ç—Å–µ–≤: {pattern[:50]}")
                return False
        
        # 2. –ü–æ–¥—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        accept_count = 0
        reject_count = 0
        
        for keyword in self.accept_keywords:
            if keyword in full_text:
                accept_count += 1
        
        for keyword in self.reject_keywords:
            if keyword in full_text:
                reject_count += 1
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –°–ò–õ–¨–ù–´–ï —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã
        strong_signal = False
        for pattern in self.strong_signal_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                strong_signal = True
                logger.debug(f"‚úÖ –°–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω: {pattern}")
                break
        
        # 4. –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–≥–∏–±–∫–∞—è –ª–æ–≥–∏–∫–∞)
        
        # –ï—Å–ª–∏ —Å–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª - –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–∞–∂–µ —Å reject
        if strong_signal:
            logger.debug(f"‚úÖ –ü—Ä–∏–Ω—è—Ç: —Å–∏–ª—å–Ω—ã–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª")
            return True
        
        # –ï—Å–ª–∏ –º–Ω–æ–≥–æ reject —Å–ª–æ–≤ –∏ –º–∞–ª–æ accept - –æ—Ç—Å–µ–∏–≤–∞–µ–º
        if reject_count >= 3 and accept_count <= 1:
            logger.debug(f"‚ùå –û—Ç—Å–µ—è–Ω: reject={reject_count}, accept={accept_count}")
            return False
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å accept —Å–ª–æ–≤–∞ - –ø—Ä–∏–Ω–∏–º–∞–µ–º
        if accept_count >= 1:
            logger.debug(f"‚úÖ –ü—Ä–∏–Ω—è—Ç: accept={accept_count}, reject={reject_count}")
            return True
        
        # –î–ª—è MOEX –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ - –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if 'moex' in news_item.get('source', '').lower():
            # MOEX —á–∞—Å—Ç–æ –ø—É–±–ª–∏–∫—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
            if any(word in title.lower() for word in ['–æ–±–ª–∏–≥–∞—Ü–∏—è–º–∏', '—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ', '–∏—Ç–æ–≥–∏', '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ']):
                return False
            # –ù–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ - –ø—Ä–∏–Ω–∏–º–∞–µ–º
            if accept_count >= 2:
                return True
        
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –æ—Ç—Å–µ–∏–≤–∞–µ–º
        logger.debug(f"‚ùå –û—Ç—Å–µ—è–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (accept={accept_count})")
        return False
    
    def get_filter_stats(self, news_list: List[Dict]) -> Dict:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏"""
        total = len(news_list)
        tradable = sum(1 for news in news_list if self.is_tradable(news))
        
        # –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –æ—Ç—Å–µ–≤–∞ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 5 –Ω–æ–≤–æ—Å—Ç–µ–π
        rejection_reasons = []
        for i, news in enumerate(news_list[:5]):
            if not self.is_tradable(news):
                title = news.get('title', '')[:50]
                reasons = self._analyze_rejection(news)
                rejection_reasons.append({
                    'title': title,
                    'reasons': reasons
                })
        
        return {
            'total_news': total,
            'tradable_news': tradable,
            'rejected_news': total - tradable,
            'tradable_percent': round((tradable / total * 100) if total > 0 else 0, 1),
            'filter_version': '2.0',
            'sample_rejections': rejection_reasons[:3]
        }
    
    def _analyze_rejection(self, news_item: Dict) -> List[str]:
        """–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –æ—Ç—Å–µ–≤–∞ –Ω–æ–≤–æ—Å—Ç–∏"""
        title = news_item.get('title', '').lower()
        content = news_item.get('content', '').lower() or news_item.get('description', '').lower()
        full_text = f"{title} {content[:300]}"
        
        reasons = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ hard reject –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        for pattern in self.hard_reject_patterns:
            if re.search(pattern, full_text, re.IGNORECASE):
                reasons.append(f"Hard reject pattern: {pattern[:40]}")
        
        # –ü–æ–¥—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        accept_found = []
        reject_found = []
        
        for keyword in self.accept_keywords[:20]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 20
            if keyword in full_text:
                accept_found.append(keyword)
        
        for keyword in self.reject_keywords[:20]:
            if keyword in full_text:
                reject_found.append(keyword)
        
        if not accept_found:
            reasons.append("–ù–µ—Ç accept –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤")
        
        if reject_found:
            reasons.append(f"Reject keywords: {', '.join(reject_found[:3])}")
        
        return reasons
